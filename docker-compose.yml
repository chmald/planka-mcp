# Planka MCP Server - Docker Compose Configuration
#
# This file provides two service configurations:
#   1. planka-mcp (default): Single-client stdio mode - recommended for individual use
#   2. planka-mcp-sse: Multi-client SSE mode - for shared/team deployments
#
# Usage:
#   Single client (stdio):  docker compose run --rm planka-mcp
#   Multi client (SSE):     docker compose up planka-mcp-sse -d

services:
  # =============================================================================
  # RECOMMENDED: Single-Client Mode (stdio)
  # =============================================================================
  # Use this mode when running the MCP server for a single user/client.
  # This is the default and recommended configuration for individual hosting.
  # 
  # The container runs in interactive mode and communicates via stdin/stdout.
  # Perfect for direct integration with Claude Desktop, VS Code, or other MCP clients.
  #
  # Usage: docker compose run --rm planka-mcp
  # =============================================================================
  planka-mcp:
    build:
      context: .
      args:
        VERSION: ${VERSION:-dev}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: chmald/planka-mcp:${VERSION:-latest}
    stdin_open: true
    tty: true
    environment:
      - MCP_TRANSPORT=stdio
      - PLANKA_BASE_URL=${PLANKA_BASE_URL:-http://host.docker.internal:3000}
      - PLANKA_USERNAME=${PLANKA_USERNAME}
      - PLANKA_PASSWORD=${PLANKA_PASSWORD}
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # =============================================================================
  # ALTERNATIVE: Multi-Client Mode (SSE)
  # =============================================================================
  # Use this mode when you need multiple clients to connect to the same MCP server.
  # Suitable for team environments or centralized deployments.
  #
  # The server exposes HTTP endpoints for SSE connections.
  # Clients connect via: http://localhost:3001/sse
  #
  # Usage: docker compose up planka-mcp-sse -d
  # =============================================================================
  planka-mcp-sse:
    build:
      context: .
      args:
        VERSION: ${VERSION:-dev}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: chmald/planka-mcp:${VERSION:-latest}
    ports:
      - "${MCP_PORT:-3001}:3001"
    environment:
      - MCP_TRANSPORT=sse
      - MCP_PORT=3001
      - PLANKA_BASE_URL=${PLANKA_BASE_URL:-http://host.docker.internal:3000}
      - PLANKA_USERNAME=${PLANKA_USERNAME}
      - PLANKA_PASSWORD=${PLANKA_PASSWORD}
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
